<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è´°ä¸‡UCLAåº—ç¼ºè´§ç»Ÿè®¡ç³»ç»Ÿ - ç®€åŒ–å¤šç”¨æˆ·ç‰ˆ</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase SDK - ä½¿ç”¨Realtime Database -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ½ï¸ è´°ä¸‡UCLAåº—ç¼ºè´§ç»Ÿè®¡ç³»ç»Ÿ</h1>
            <p>ç®€åŒ–å¤šç”¨æˆ·ç‰ˆ - ä½¿ç”¨Realtime Databaseå®ç°å®æ—¶åŒæ­¥</p>
            <div class="user-info">
                <div class="connection-status" id="connectionStatus">
                    <span class="status-indicator offline">â—</span>
                    <span>è¿æ¥ä¸­...</span>
                </div>
                <div class="user-identity" id="userIdentity">
                    <span>ğŸ‘¤ ç”¨æˆ·èº«ä»½ï¼š</span>
                    <input type="text" id="userName" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å" maxlength="20">
                    <button id="setUserName" class="user-btn">ç¡®è®¤èº«ä»½</button>
                </div>
            </div>
        </header>

        <div class="main-content">
            <!-- ç¼ºè´§ä¿¡æ¯è¾“å…¥åŒºåŸŸ -->
            <div class="input-section">
                <h2>ğŸ“ ä¸ŠæŠ¥ç¼ºè´§æƒ…å†µ</h2>
                <form id="shortageForm" class="shortage-form">
                    <div class="form-group">
                        <label for="productName">äº§å“åç§° *</label>
                        <input type="text" id="productName" name="productName" required 
                               placeholder="ä¾‹å¦‚ï¼šè‚˜å­è‚‰ï¼ˆå•æ¬¡åªå¡«æŠ¥åªå†™ä¸€é¡¹ï¼‰">
                    </div>
                    
                    <div class="form-group">
                        <label for="category">äº§å“ç±»åˆ« *</label>
                        <select id="category" name="category" required>
                            <option value="">è¯·é€‰æ‹©ç±»åˆ«</option>
                            <option value="è‚‰ç±»&è‚‰æ±¤">ğŸ¥© è‚‰ç±»&è‚‰æ±¤</option>
                            <option value="å…³ä¸œç…®&å¤å‘³">ğŸ¢ å…³ä¸œç…®&å¤å‘³</option>
                            <option value="ä¸»é£Ÿ">ğŸš ä¸»é£Ÿ</option>
                            <option value="è”¬èœ">ğŸ¥¬ è”¬èœ</option>
                            <option value="è°ƒæ–™">ğŸ§‚ è°ƒæ–™</option>
                            <option value="é¥®å“">ğŸ¥¤ é¥®å“</option>
                            <option value="åŒ…è£…ç”¨å…·">ğŸ“¦ åŒ…è£…ç”¨å…·</option>
                            <option value="å…¶ä»–">ğŸ“¦ å…¶ä»–</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="shortageLevel">ç¼ºè´§ç¨‹åº¦ *</label>
                        <select id="shortageLevel" name="shortageLevel" required>
                            <option value="">è¯·é€‰æ‹©ç¼ºè´§ç¨‹åº¦</option>
                            <option value="å®Œå…¨ç¼ºè´§">ğŸ”´ å®Œå…¨ç¼ºè´§ï¼ˆå¤‡æ³¨è¯´æ˜å‰©ä½™ï¼‰</option>
                            <option value="ä¸¥é‡">ğŸ”µ ä¸¥é‡ç¼ºè´§ï¼ˆå¤‡æ³¨è¯´æ˜å‰©ä½™ï¼‰</option>
                            <option value="è½»å¾®">ğŸŸ¡ è½»å¾®ç¼ºè´§ (3-5å¤©ç”¨é‡)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="reporter">ä¸ŠæŠ¥äºº *</label>
                        <input type="text" id="reporter" name="reporter" required 
                               placeholder="è¯·å…ˆç¡®è®¤ç”¨æˆ·èº«ä»½" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="notes">å¤‡æ³¨ä¿¡æ¯</label>
                        <textarea id="notes" name="notes" rows="3" 
                                  placeholder="è¡¥å……è¯´æ˜ï¼Œå¦‚ åªå‰©ä¸€ç›’"></textarea>
                    </div>
                    
                    <button type="submit" class="submit-btn">ğŸ“¤ æäº¤ç¼ºè´§ä¿¡æ¯</button>
                </form>
            </div>

            <!-- å®æ—¶æ˜¾ç¤ºåŒºåŸŸ -->
            <div class="display-section">
                <h2>ğŸ“Š ä»Šæ—¥ç¼ºè´§ç»Ÿè®¡</h2>
                <div class="stats-overview">
                    <div class="stat-card">
                        <span class="stat-number" id="totalShortages">0</span>
                        <span class="stat-label">æ€»ç¼ºè´§é¡¹</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="urgentShortages">0</span>
                        <span class="stat-label">ç´§æ€¥ç¼ºè´§</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="pendingRestock">0</span>
                        <span class="stat-label">å¾…è¡¥è´§</span>
                    </div>
                </div>
                
                <div class="recent-shortages">
                    <h3>ğŸ“‹ å½“æ—¥ä¸ŠæŠ¥</h3>
                    <div id="recentList" class="shortage-list">
                        <p class="no-data">æš‚æ— ç¼ºè´§è®°å½•</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- å¯¼å‡ºåŠŸèƒ½ -->
        <div class="export-section">
            <h2>ğŸ“‹ æ•°æ®å¯¼å‡º</h2>
            <div class="export-buttons">
                <button id="exportExcel" class="export-btn">ğŸ“Š å¯¼å‡ºExcelæŠ¥è¡¨</button>
                <button id="exportSummary" class="export-btn">ğŸ“ å¯¼å‡ºæ±‡æ€»æŠ¥å‘Š</button>
                <button id="historyData" class="export-btn">ğŸ“š å†å²æ•°æ®</button>
            </div>
        </div>
    </div>

    <!-- ä¿®æ”¹/åˆ é™¤å¼¹çª— -->
    <div id="actionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>é€‰æ‹©æ“ä½œ</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <p>è¯·é€‰æ‹©è¦å¯¹è¿™æ¡ç¼ºè´§è®°å½•è¿›è¡Œçš„æ“ä½œï¼š</p>
                <div class="modal-actions">
                    <button id="editBtn" class="modal-btn edit-btn">
                        <span class="btn-text">ä¿®æ”¹</span>
                    </button>
                    <button id="deleteBtn" class="modal-btn delete-btn">
                        <span class="btn-text">åˆ é™¤</span>
                    </button>
                    <button id="markRestockedBtn" class="modal-btn restock-btn">
                        <span class="btn-text">æ ‡è®°å·²è¡¥è´§</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- å†å²æ•°æ®å¼¹çª— -->
    <div id="historyModal" class="modal">
        <div class="modal-content history-modal">
            <div class="modal-header">
                <h3>ğŸ“š å†å²ç¼ºè´§è®°å½•</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="history-controls">
                    <select id="historyDateSelect" class="history-select">
                        <option value="">é€‰æ‹©æ—¥æœŸæŸ¥çœ‹</option>
                    </select>
                    <button id="exportHistoryBtn" class="modal-btn edit-btn">å¯¼å‡º</button>
                </div>
                <div id="historyContent" class="history-content">
                    <p class="no-data">è¯·é€‰æ‹©æ—¥æœŸæŸ¥çœ‹å†å²è®°å½•</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ç®€åŒ–å¤šç”¨æˆ·ç‰ˆ - ä½¿ç”¨Realtime Database
        class SimpleMultiUserTracker {
            constructor() {
                this.shortages = [];
                this.currentEditingId = null;
                this.currentUser = null;
                this.isOnline = false;
                this.database = null;
                this.init();
            }

            // åˆå§‹åŒ–
            async init() {
                this.bindEvents();
                await this.initializeFirebase();
                this.loadDataFromLocal();
                this.updateDisplay();
            }

            // åˆå§‹åŒ–Firebaseè¿æ¥
            async initializeFirebase() {
                try {
                    // æ£€æŸ¥Firebaseæ˜¯å¦å¯ç”¨
                    if (typeof firebase === 'undefined') {
                        console.warn('Firebase SDKæœªåŠ è½½ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨æ¨¡å¼');
                        this.isOnline = false;
                        this.updateConnectionStatus();
                        return;
                    }

                    // Firebase é…ç½®
                    const firebaseConfig = {
                        apiKey: "AIzaSyDaEFljR6wxQaPj_4YH7hWFgR6ZGU8_2mY",
                        authDomain: "erwan-inventory-system.firebaseapp.com",
                        projectId: "erwan-inventory-system",
                        storageBucket: "erwan-inventory-system.firebasestorage.app",
                        messagingSenderId: "707188745863",
                        appId: "1:707188745863:web:f4c9cbf0e84b03a0daba22",
                        measurementId: "G-M8KHPCT1L0"
                    };

                    // åˆå§‹åŒ–Firebase
                    firebase.initializeApp(firebaseConfig);
                    this.database = firebase.database();
                    
                    // æµ‹è¯•è¿æ¥
                    await this.database.ref('test').set({ message: 'test' });
                    
                    this.isOnline = true;
                    this.updateConnectionStatus();
                    console.log('Firebase Realtime Databaseè¿æ¥æˆåŠŸ');
                    
                    // è®¾ç½®å®æ—¶ç›‘å¬
                    this.setupRealtimeListener();
                    
                } catch (error) {
                    console.warn('Firebaseè¿æ¥å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨æ¨¡å¼:', error);
                    this.isOnline = false;
                    this.updateConnectionStatus();
                }
            }

            // è®¾ç½®å®æ—¶ç›‘å¬å™¨
            setupRealtimeListener() {
                if (!this.isOnline || !this.database) return;

                this.database.ref('shortages').on('value', (snapshot) => {
                    const data = snapshot.val();
                    this.shortages = data ? Object.values(data) : [];
                    this.updateDisplay();
                    console.log('å®æ—¶æ•°æ®åŒæ­¥:', this.shortages.length, 'æ¡è®°å½•');
                });
            }

            // æ›´æ–°è¿æ¥çŠ¶æ€æ˜¾ç¤º
            updateConnectionStatus() {
                const statusEl = document.getElementById('connectionStatus');
                if (!statusEl) return;

                const indicator = statusEl.querySelector('.status-indicator');
                const text = statusEl.querySelector('span:last-child');

                if (this.isOnline) {
                    indicator.className = 'status-indicator online';
                    text.textContent = 'å·²è¿æ¥ - å®æ—¶åŒæ­¥';
                } else {
                    indicator.className = 'status-indicator offline';
                    text.textContent = 'ç¦»çº¿æ¨¡å¼ - æœ¬åœ°å­˜å‚¨';
                }
            }

            // ç»‘å®šäº‹ä»¶
            bindEvents() {
                // ç”¨æˆ·èº«ä»½è®¾ç½®
                document.getElementById('setUserName').addEventListener('click', () => {
                    this.setUserIdentity();
                });

                document.getElementById('userName').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.setUserIdentity();
                    }
                });

                // è¡¨å•æäº¤
                document.getElementById('shortageForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.submitShortage();
                });

                // å¯¼å‡ºæŒ‰é’®
                document.getElementById('exportExcel').addEventListener('click', () => {
                    this.exportToExcel();
                });

                document.getElementById('exportSummary').addEventListener('click', () => {
                    this.exportSummary();
                });

                document.getElementById('historyData').addEventListener('click', () => {
                    this.showHistoryModal();
                });

                // å¼¹çª—äº‹ä»¶
                document.getElementById('editBtn').addEventListener('click', () => {
                    this.editShortage();
                });

                document.getElementById('deleteBtn').addEventListener('click', () => {
                    this.deleteShortage();
                });

                document.getElementById('markRestockedBtn').addEventListener('click', () => {
                    this.markAsRestocked();
                });

                // å…³é—­å¼¹çª—
                document.querySelector('.close').addEventListener('click', () => {
                    this.closeModal();
                });

                document.getElementById('actionModal').addEventListener('click', (e) => {
                    if (e.target.id === 'actionModal') {
                        this.closeModal();
                    }
                });
            }

            // è®¾ç½®ç”¨æˆ·èº«ä»½
            setUserIdentity() {
                const userName = document.getElementById('userName').value.trim();
                if (!userName) {
                    this.showMessage('è¯·è¾“å…¥æ‚¨çš„å§“åï¼', 'warning');
                    return;
                }

                this.currentUser = userName;
                localStorage.setItem('currentUser', userName);
                
                // è‡ªåŠ¨å¡«å……ä¸ŠæŠ¥äººå­—æ®µ
                document.getElementById('reporter').value = userName;
                document.getElementById('reporter').placeholder = `å½“å‰ç”¨æˆ·ï¼š${userName}`;
                document.getElementById('reporter').readOnly = true;
                
                this.showMessage(`èº«ä»½ç¡®è®¤æˆåŠŸï¼š${userName}`, 'success');
                
                // éšè—ç”¨æˆ·èº«ä»½è®¾ç½®
                const userIdentity = document.getElementById('userIdentity');
                userIdentity.innerHTML = `
                    <span>ğŸ‘¤ å½“å‰ç”¨æˆ·ï¼š${userName}</span>
                    <button id="changeUser" class="user-btn">åˆ‡æ¢ç”¨æˆ·</button>
                `;
                
                document.getElementById('changeUser').addEventListener('click', () => {
                    this.resetUserIdentity();
                });
            }

            // é‡ç½®ç”¨æˆ·èº«ä»½
            resetUserIdentity() {
                this.currentUser = null;
                localStorage.removeItem('currentUser');
                
                // æ¸…ç©ºä¸ŠæŠ¥äººå­—æ®µ
                document.getElementById('reporter').value = '';
                document.getElementById('reporter').placeholder = 'è¯·å…ˆç¡®è®¤ç”¨æˆ·èº«ä»½';
                document.getElementById('reporter').readOnly = true;
                
                const userIdentity = document.getElementById('userIdentity');
                userIdentity.innerHTML = `
                    <span>ğŸ‘¤ ç”¨æˆ·èº«ä»½ï¼š</span>
                    <input type="text" id="userName" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å" maxlength="20">
                    <button id="setUserName" class="user-btn">ç¡®è®¤èº«ä»½</button>
                `;
                
                document.getElementById('setUserName').addEventListener('click', () => {
                    this.setUserIdentity();
                });
            }

            // æäº¤ç¼ºè´§ä¿¡æ¯
            async submitShortage() {
                if (!this.currentUser) {
                    this.showMessage('è¯·å…ˆç¡®è®¤æ‚¨çš„èº«ä»½ï¼', 'warning');
                    return;
                }

                const form = document.getElementById('shortageForm');
                const formData = new FormData(form);
                
                const now = new Date();
                const laTime = new Date(now.toLocaleString("en-US", {timeZone: "America/Los_Angeles"}));
                const laDateStr = laTime.toISOString().split('T')[0];
                const laTimestamp = laTime.toLocaleString('zh-CN');
                
                const shortage = {
                    productName: formData.get('productName'),
                    category: formData.get('category'),
                    shortageLevel: formData.get('shortageLevel'),
                    reporter: this.currentUser,
                    notes: formData.get('notes'),
                    timestamp: laTimestamp,
                    date: laDateStr,
                    isRestocked: false
                };

                // éªŒè¯å¿…å¡«å­—æ®µ
                if (!shortage.productName || !shortage.category || !shortage.shortageLevel) {
                    this.showMessage('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µï¼', 'warning');
                    return;
                }

                try {
                    if (this.isOnline && this.database) {
                        // åœ¨çº¿æ¨¡å¼ï¼šä¿å­˜åˆ°Firebase
                        const newShortageRef = this.database.ref('shortages').push();
                        await newShortageRef.set(shortage);
                        this.showMessage('ç¼ºè´§ä¿¡æ¯æäº¤æˆåŠŸï¼', 'success');
                    } else {
                        // ç¦»çº¿æ¨¡å¼ï¼šä¿å­˜åˆ°æœ¬åœ°
                        shortage.id = Date.now();
                        this.shortages.push(shortage);
                        this.saveDataToLocal();
                        this.updateDisplay();
                        this.showMessage('ç¼ºè´§ä¿¡æ¯æäº¤æˆåŠŸï¼', 'success');
                    }

                    form.reset();
                    document.getElementById('reporter').value = this.currentUser;
                    document.getElementById('reporter').readOnly = true;
                    
                } catch (error) {
                    console.error('æäº¤å¤±è´¥:', error);
                    this.showMessage('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•ï¼', 'error');
                }
            }

            // æ›´æ–°æ˜¾ç¤º
            updateDisplay() {
                this.updateStats();
                this.updateRecentList();
            }

            // æ›´æ–°ç»Ÿè®¡æ•°æ®
            updateStats() {
                const now = new Date();
                const laTime = new Date(now.toLocaleString("en-US", {timeZone: "America/Los_Angeles"}));
                const todayStr = laTime.toISOString().split('T')[0];
                
                const todayShortages = this.shortages.filter(s => s.date === todayStr);
                
                const totalShortages = todayShortages.length;
                const urgentShortages = todayShortages.filter(s => 
                    s.shortageLevel === 'ä¸¥é‡' || s.shortageLevel === 'å®Œå…¨ç¼ºè´§'
                ).length;
                
                const pendingRestock = this.shortages.filter(s => !s.isRestocked).length;

                document.getElementById('totalShortages').textContent = totalShortages;
                document.getElementById('urgentShortages').textContent = urgentShortages;
                document.getElementById('pendingRestock').textContent = pendingRestock;
            }

            // æ›´æ–°å½“æ—¥ä¸ŠæŠ¥åˆ—è¡¨
            updateRecentList() {
                const recentList = document.getElementById('recentList');
                
                const now = new Date();
                const laTime = new Date(now.toLocaleString("en-US", {timeZone: "America/Los_Angeles"}));
                const todayStr = laTime.toISOString().split('T')[0];
                
                const todayShortages = this.shortages
                    .filter(s => s.date === todayStr && !s.isRestocked)
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                if (todayShortages.length === 0) {
                    recentList.innerHTML = '<p class="no-data">ä»Šæ—¥æš‚æ— ç¼ºè´§è®°å½•</p>';
                    return;
                }

                recentList.innerHTML = todayShortages.map(shortage => `
                    <div class="shortage-item ${this.getUrgencyClass(shortage.shortageLevel)}" data-id="${shortage.id || 'temp'}" style="cursor: pointer;">
                        <div class="shortage-header">
                            <span class="product-name">${shortage.productName}</span>
                            <span class="shortage-level ${shortage.shortageLevel}">${this.getShortageLevelText(shortage.shortageLevel)}</span>
                        </div>
                        <div class="shortage-details">
                            <div><strong>ç±»åˆ«:</strong> ${shortage.category}</div>
                            <div><strong>ä¸ŠæŠ¥äºº:</strong> ${shortage.reporter}</div>
                            <div><strong>æ—¶é—´:</strong> ${shortage.timestamp}</div>
                            ${shortage.notes ? `<div><strong>å¤‡æ³¨:</strong> ${shortage.notes}</div>` : ''}
                        </div>
                    </div>
                `).join('');

                // ä¸ºæ¯ä¸ªç¼ºè´§è®°å½•æ·»åŠ ç‚¹å‡»äº‹ä»¶
                recentList.querySelectorAll('.shortage-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        const id = item.dataset.id;
                        this.showActionModal(id);
                    });
                });
            }

            // è·å–ç´§æ€¥ç¨‹åº¦æ ·å¼ç±»
            getUrgencyClass(level) {
                if (level === 'ä¸¥é‡' || level === 'å®Œå…¨ç¼ºè´§') return 'urgent';
                return '';
            }

            // è·å–ç¼ºè´§ç¨‹åº¦æ–‡æœ¬
            getShortageLevelText(level) {
                const levelMap = {
                    'è½»å¾®': 'ğŸŸ¡ è½»å¾®',
                    'ä¸¥é‡': 'ğŸ”µ ä¸¥é‡',
                    'å®Œå…¨ç¼ºè´§': 'ğŸ”´ å®Œå…¨ç¼ºè´§'
                };
                return levelMap[level] || level;
            }

            // æ˜¾ç¤ºæ“ä½œå¼¹çª—
            showActionModal(id) {
                this.currentEditingId = id;
                document.getElementById('actionModal').style.display = 'block';
            }

            // å…³é—­å¼¹çª—
            closeModal() {
                document.getElementById('actionModal').style.display = 'none';
            }

            // ç¼–è¾‘ç¼ºè´§è®°å½•
            editShortage() {
                if (!this.currentEditingId) return;
                
                const shortage = this.shortages.find(s => (s.id || 'temp') === this.currentEditingId);
                if (!shortage) return;

                // å¡«å……è¡¨å•
                document.getElementById('productName').value = shortage.productName;
                document.getElementById('category').value = shortage.category;
                document.getElementById('shortageLevel').value = shortage.shortageLevel;
                document.getElementById('reporter').value = shortage.reporter;
                document.getElementById('notes').value = shortage.notes || '';

                // æ›´æ–°æäº¤æŒ‰é’®æ–‡æœ¬
                const submitBtn = document.querySelector('.submit-btn');
                submitBtn.textContent = 'âœï¸ ä¿®æ”¹ç¼ºè´§ä¿¡æ¯';
                submitBtn.style.background = 'linear-gradient(135deg, #f39c12, #e67e22)';

                // æ»šåŠ¨åˆ°è¡¨å•
                document.querySelector('.input-section').scrollIntoView({ behavior: 'smooth' });
                
                this.closeModal();
                this.showMessage('è¯·ä¿®æ”¹è¡¨å•ä¸­çš„ä¿¡æ¯ï¼Œç„¶åç‚¹å‡»ä¿®æ”¹æŒ‰é’®', 'info');
            }

            // åˆ é™¤ç¼ºè´§è®°å½•
            async deleteShortage() {
                if (!this.currentEditingId) return;
                
                if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡ç¼ºè´§è®°å½•å—ï¼Ÿ')) {
                    try {
                        if (this.isOnline && this.database) {
                            // åœ¨çº¿æ¨¡å¼ï¼šä»Firebaseåˆ é™¤
                            const shortage = this.shortages.find(s => (s.id || 'temp') === this.currentEditingId);
                            if (shortage && shortage.firebaseKey) {
                                await this.database.ref('shortages').child(shortage.firebaseKey).remove();
                            }
                        } else {
                            // ç¦»çº¿æ¨¡å¼ï¼šä»æœ¬åœ°åˆ é™¤
                            this.shortages = this.shortages.filter(s => (s.id || 'temp') !== this.currentEditingId);
                            this.saveDataToLocal();
                        }
                        
                        this.updateDisplay();
                        this.closeModal();
                        this.showMessage('ç¼ºè´§è®°å½•å·²åˆ é™¤ï¼', 'warning');
                    } catch (error) {
                        console.error('åˆ é™¤å¤±è´¥:', error);
                        this.showMessage('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•ï¼', 'error');
                    }
                }
            }

            // æ ‡è®°ä¸ºå·²è¡¥è´§
            async markAsRestocked() {
                if (!this.currentEditingId) return;
                
                const shortage = this.shortages.find(s => (s.id || 'temp') === this.currentEditingId);
                if (!shortage) return;

                if (shortage.isRestocked) {
                    this.showMessage('è¯¥è®°å½•å·²ç»æ ‡è®°ä¸ºå·²è¡¥è´§ï¼', 'info');
                    return;
                }

                if (confirm('ç¡®å®šè¦å°†æ­¤å•†å“æ ‡è®°ä¸ºå·²è¡¥è´§å—ï¼Ÿ')) {
                    try {
                        shortage.isRestocked = true;
                        shortage.restockedTime = new Date().toLocaleString('zh-CN');

                        if (this.isOnline && this.database) {
                            // åœ¨çº¿æ¨¡å¼ï¼šæ›´æ–°Firebase
                            if (shortage.firebaseKey) {
                                await this.database.ref('shortages').child(shortage.firebaseKey).update({
                                    isRestocked: true,
                                    restockedTime: shortage.restockedTime
                                });
                            }
                        } else {
                            // ç¦»çº¿æ¨¡å¼ï¼šæ›´æ–°æœ¬åœ°
                            this.saveDataToLocal();
                        }

                        this.updateDisplay();
                        this.closeModal();
                        this.showMessage('å·²æ ‡è®°ä¸ºå·²è¡¥è´§ï¼', 'success');
                    } catch (error) {
                        console.error('æ ‡è®°å¤±è´¥:', error);
                        this.showMessage('æ ‡è®°å¤±è´¥ï¼Œè¯·é‡è¯•ï¼', 'error');
                    }
                }
            }

            // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®
            loadDataFromLocal() {
                const data = localStorage.getItem('restaurantShortages');
                this.shortages = data ? JSON.parse(data) : [];
            }

            // ä¿å­˜æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
            saveDataToLocal() {
                localStorage.setItem('restaurantShortages', JSON.stringify(this.shortages));
            }

            // å¯¼å‡ºExcelæŠ¥è¡¨
            exportToExcel() {
                const today = new Date().toISOString().split('T')[0];
                const todayShortages = this.shortages.filter(s => s.date === today);
                
                if (todayShortages.length === 0) {
                    alert('ä»Šæ—¥æš‚æ— ç¼ºè´§æ•°æ®å¯å¯¼å‡ºï¼');
                    return;
                }

                const headers = ['äº§å“åç§°', 'ç±»åˆ«', 'ç¼ºè´§ç¨‹åº¦', 'ä¸ŠæŠ¥äºº', 'å¤‡æ³¨', 'ä¸ŠæŠ¥æ—¶é—´'];
                const csvContent = [
                    headers.join(','),
                    ...todayShortages.map(s => [
                        s.productName,
                        s.category,
                        s.shortageLevel,
                        s.reporter,
                        s.notes || '',
                        s.timestamp
                    ].map(field => `"${field}"`).join(','))
                ].join('\n');

                this.downloadFile(csvContent, `ç¼ºè´§ç»Ÿè®¡_${today}.csv`, 'text/csv');
                this.showMessage('ExcelæŠ¥è¡¨å¯¼å‡ºæˆåŠŸï¼', 'success');
            }

            // å¯¼å‡ºæ±‡æ€»æŠ¥å‘Š
            exportSummary() {
                const today = new Date().toISOString().split('T')[0];
                const todayShortages = this.shortages.filter(s => s.date === today);
                
                if (todayShortages.length === 0) {
                    alert('ä»Šæ—¥æš‚æ— ç¼ºè´§æ•°æ®å¯å¯¼å‡ºï¼');
                    return;
                }

                const categoryStats = {};
                const levelStats = {};
                
                todayShortages.forEach(s => {
                    categoryStats[s.category] = (categoryStats[s.category] || 0) + 1;
                    levelStats[s.shortageLevel] = (levelStats[s.shortageLevel] || 0) + 1;
                });

                let report = `é¤å…ç¼ºè´§ç»Ÿè®¡æ±‡æ€»æŠ¥å‘Š\n`;
                report += `ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString('zh-CN')}\n`;
                report += `ç»Ÿè®¡æ—¥æœŸ: ${today}\n\n`;
                
                report += `=== æ€»ä½“ç»Ÿè®¡ ===\n`;
                report += `æ€»ç¼ºè´§é¡¹æ•°: ${todayShortages.length}\n`;
                report += `æ¶‰åŠç±»åˆ«æ•°: ${Object.keys(categoryStats).length}\n\n`;
                
                report += `=== æŒ‰ç±»åˆ«ç»Ÿè®¡ ===\n`;
                Object.entries(categoryStats)
                    .sort((a, b) => b[1] - a[1])
                    .forEach(([category, count]) => {
                        report += `${category}: ${count}é¡¹\n`;
                    });
                
                report += `\n=== æŒ‰ç¼ºè´§ç¨‹åº¦ç»Ÿè®¡ ===\n`;
                Object.entries(levelStats)
                    .sort((a, b) => b[1] - a[1])
                    .forEach(([level, count]) => {
                        report += `${level}: ${count}é¡¹\n`;
                    });
                
                report += `\n=== è¯¦ç»†ç¼ºè´§æ¸…å• ===\n`;
                todayShortages.forEach((s, index) => {
                    report += `${index + 1}. ${s.productName} (${s.category}) - ${s.shortageLevel}\n`;
                    report += `   ä¸ŠæŠ¥äºº: ${s.reporter} | æ—¶é—´: ${s.timestamp}\n`;
                    if (s.notes) report += `   å¤‡æ³¨: ${s.notes}\n`;
                    report += `\n`;
                });

                this.downloadFile(report, `ç¼ºè´§æ±‡æ€»æŠ¥å‘Š_${today}.txt`, 'text/plain');
                this.showMessage('æ±‡æ€»æŠ¥å‘Šå¯¼å‡ºæˆåŠŸï¼', 'success');
            }

            // æ˜¾ç¤ºå†å²æ•°æ®å¼¹çª—
            showHistoryModal() {
                // ç®€åŒ–ç‰ˆæš‚ä¸æ”¯æŒå†å²æ•°æ®
                alert('ç®€åŒ–ç‰ˆæš‚ä¸æ”¯æŒå†å²æ•°æ®åŠŸèƒ½');
            }

            // ä¸‹è½½æ–‡ä»¶
            downloadFile(content, filename, mimeType) {
                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }

            // æ˜¾ç¤ºæ¶ˆæ¯
            showMessage(message, type = 'info') {
                const messageEl = document.createElement('div');
                messageEl.className = `message message-${type}`;
                messageEl.textContent = message;
                messageEl.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 15px 20px;
                    border-radius: 10px;
                    color: white;
                    font-weight: 500;
                    z-index: 1000;
                    animation: slideIn 0.3s ease;
                    max-width: 300px;
                `;

                const colors = {
                    success: '#27ae60',
                    warning: '#f39c12',
                    error: '#e74c3c',
                    info: '#3498db'
                };
                messageEl.style.backgroundColor = colors[type] || colors.info;

                document.body.appendChild(messageEl);

                setTimeout(() => {
                    messageEl.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => {
                        if (messageEl.parentNode) {
                            messageEl.parentNode.removeChild(messageEl);
                        }
                    }, 300);
                }, 3000);
            }
        }

        // æ·»åŠ CSSåŠ¨ç”»
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            
            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„ç”¨æˆ·èº«ä»½
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                document.getElementById('userName').value = savedUser;
                // è‡ªåŠ¨å¡«å……ä¸ŠæŠ¥äººå­—æ®µ
                document.getElementById('reporter').value = savedUser;
                document.getElementById('reporter').placeholder = `å½“å‰ç”¨æˆ·ï¼š${savedUser}`;
                document.getElementById('reporter').readOnly = true;
            }
            
            new SimpleMultiUserTracker();
        });
    </script>
</body>
</html>
